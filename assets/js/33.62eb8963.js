(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{353:function(t,a,s){t.exports=s.p+"assets/img/eventloop.2af1b96d.jpeg"},423:function(t,a,s){"use strict";s.r(a);var e=s(33),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("p",[t._v("从需求开始，为什么要了解Eventloop？先举个简单的栗子🌰：\n")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("validate")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timeStamp "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" timeStamp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("500")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("validate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("上述的代码的运行结果是什么呢？是"),e("code",[t._v("500")]),t._v("吗？")]),t._v(" "),e("p",[t._v("事实上，当我们尝试多次运行validate函数，会发现，"),e("code",[t._v("setTimeout")]),t._v("的回调函数打印出来的结果并不是我们想象中的500，甚至不是一个固定的数值。")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("validate(); // 501\nvalidate(); // 503\nvalidate(); // 502\n")])])]),e("p",[t._v("为什么定时器不如我们想象中的方式运作呢？")]),t._v(" "),e("p",[t._v("让我们带着疑问，来学习Eventloop吧。")]),t._v(" "),e("p",[t._v("通过学习Eventloop，深入了解Js在浏览器中的运行机制，以方便我们在工作和学习中更加轻松的解决各种问题。")]),t._v(" "),e("h2",{attrs:{id:"什么是eventloop"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#什么是eventloop"}},[t._v("#")]),t._v(" 什么是Eventloop")]),t._v(" "),e("p",[t._v("我们都知道："),e("strong",[t._v("JS是一门单线程语言")]),t._v("。那么像"),e("code",[t._v("setTimeout")]),t._v("这样的异步代码究竟是如何运行的呢？")]),t._v(" "),e("p",[t._v("首先，我们从"),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTML5 standard"),e("OutboundLink")],1),t._v("中了解到：一个eventloop有一个或多个任务队列（Task queues），一个Task queue包含一组task。")]),t._v(" "),e("p",[t._v("值得注意的是，"),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTML5 standard"),e("OutboundLink")],1),t._v("特意提醒了我们：")]),t._v(" "),e("blockquote",[e("p",[e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("Task queues"),e("OutboundLink")],1),t._v(" "),e("em",[t._v("are")]),t._v(" "),e("a",{attrs:{href:"https://infra.spec.whatwg.org/#ordered-set",target:"_blank",rel:"noopener noreferrer"}},[t._v("sets"),e("OutboundLink")],1),e("em",[t._v(", not")]),t._v(" "),e("a",{attrs:{href:"https://infra.spec.whatwg.org/#queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("queues"),e("OutboundLink")],1),e("em",[t._v(", because")]),t._v(" "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#step1",target:"_blank",rel:"noopener noreferrer"}},[t._v("step one of the event loop processing model"),e("OutboundLink")],1),t._v(" "),e("em",[t._v("grabs the first")]),t._v(" "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task-runnable",target:"_blank",rel:"noopener noreferrer"}},[e("em",[t._v("runnable")]),e("OutboundLink")],1),t._v(" "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task",target:"_blank",rel:"noopener noreferrer"}},[t._v("task"),e("OutboundLink")],1),t._v(" "),e("em",[t._v("from the chosen queue, instead of")]),t._v(" "),e("a",{attrs:{href:"https://infra.spec.whatwg.org/#queue-dequeue",target:"_blank",rel:"noopener noreferrer"}},[t._v("dequeuing"),e("OutboundLink")],1),t._v(" "),e("em",[t._v("the first task.")])])]),t._v(" "),e("p",[t._v("来看一张经典的eventloop运行图。")]),t._v(" "),e("p",[e("img",{attrs:{src:s(353),alt:"eventloop"}})]),t._v(" "),e("p",[t._v("如图所示，task执行时会会将代码push进调用栈（Call Stack），执行完毕后，以后进先出的原则从调用栈中移除。调用栈中遇到异步API时，满足条件后将异步API的回调函数放入事件队列（Event Queue）中， 等待当前调用栈清空后，以先进先出的原则，执行事件队列中的回调函数，如此循环往复，就是"),e("strong",[t._v("Eventloop")]),t._v("。")]),t._v(" "),e("p",[t._v("到这里，我们回到第一个问题，"),e("strong",[t._v("为什么setTimeout定时器不如我们想象中准确呢？")])]),t._v(" "),e("p",[t._v("答案已经呼之欲出了：定时器设置的时间过后，"),e("code",[t._v("setTimeout")]),t._v("的回调函数放入事件队列后，等待调用栈执行的这段时间，造成了定时器执行的误差。")]),t._v(" "),e("p",[t._v("让我们更加深入一点，当Promise遇上")]),t._v(" "),e("p",[t._v("借用一下Jake Archibald的例子。")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[t._v("console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script start'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTimeout'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nPromise"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise1'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise2'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nconsole"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script end'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("上面这段代码的输出结果会是怎样的呢？")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[t._v("script start\nscript end\npromise1\npromise2\nsetTimeout\n")])])]),e("p",[t._v("咦，和想象中的结果不太一样对不对？")]),t._v(" "),e("p",[t._v("按照前文的描述，我们理想的结果应当是:")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[t._v("script start\nscript end\nsetTimeout\npromise1\npromise2\n")])])]),e("p",[t._v("为什么呢？")]),t._v(" "),e("h2",{attrs:{id:"宏任务和微任务"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#宏任务和微任务"}},[t._v("#")]),t._v(" 宏任务和微任务")]),t._v(" "),e("p",[t._v("不急，让我们先看看"),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#task-queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("HTML5 standard"),e("OutboundLink")],1),t._v("中对"),e("strong",[t._v("eventloop")]),t._v("的这样一段描述：")]),t._v(" "),e("blockquote",[e("p",[t._v("Each "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop",target:"_blank",rel:"noopener noreferrer"}},[t._v("event loop"),e("OutboundLink")],1),t._v(" has a currently running task, which is either a "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task",target:"_blank",rel:"noopener noreferrer"}},[t._v("task"),e("OutboundLink")],1),t._v(" or null. Initially, this is null. It is used to handle reentrancy.")]),t._v(" "),e("p",[t._v("Each "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop",target:"_blank",rel:"noopener noreferrer"}},[t._v("event loop"),e("OutboundLink")],1),t._v(" has a microtask queue, which is a "),e("a",{attrs:{href:"https://infra.spec.whatwg.org/#queue",target:"_blank",rel:"noopener noreferrer"}},[t._v("queue"),e("OutboundLink")],1),t._v(" of "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#microtask",target:"_blank",rel:"noopener noreferrer"}},[t._v("microtasks"),e("OutboundLink")],1),t._v(", initially empty. A microtask is a colloquial way of referring to a "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#concept-task",target:"_blank",rel:"noopener noreferrer"}},[t._v("task"),e("OutboundLink")],1),t._v(" that was created via the "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#queue-a-microtask",target:"_blank",rel:"noopener noreferrer"}},[t._v("queue a microtask"),e("OutboundLink")],1),t._v(" algorithm.")]),t._v(" "),e("p",[t._v("Each "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#event-loop",target:"_blank",rel:"noopener noreferrer"}},[t._v("event loop"),e("OutboundLink")],1),t._v(" has a performing a microtask checkpoint boolean, which is initially false. It is used to prevent reentrant invocation of the "),e("a",{attrs:{href:"https://html.spec.whatwg.org/multipage/webappapis.html#perform-a-microtask-checkpoint",target:"_blank",rel:"noopener noreferrer"}},[t._v("perform a microtask checkpoint"),e("OutboundLink")],1),t._v(" algorithm.")])]),t._v(" "),e("p",[t._v("通常，我们会将异步API分为"),e("strong",[t._v("宏任务（macrotask）"),e("strong",[t._v("和")]),t._v("微任务（microtask）")]),t._v("，也就是上述标准中的task和microtask。"),e("strong",[t._v("微任务会先于宏任务执行，宏任务会触发一次完整的事件循环，而微任务不会。")])]),t._v(" "),e("p",[e("strong",[t._v("常见的浏览器微任务/宏任务")])]),t._v(" "),e("blockquote",[e("p",[e("strong",[t._v("宏任务（macrotask）")]),t._v("：setTimeout、setInterval、I/O、UI 交互事件等。")]),t._v(" "),e("p",[e("strong",[t._v("微任务（microtask）")]),t._v("：Promise.then、 MutationObserver等。")])]),t._v(" "),e("p",[t._v("基于宏任务和微任务，让我们再完善一下对于"),e("strong",[t._v("Eventloop")]),t._v("的描述：")]),t._v(" "),e("ol",[e("li",[t._v("task执行时会会将代码push进调用栈（Call Stack），执行完毕后，以后进先出的原则从调用栈中移除；")]),t._v(" "),e("li",[t._v("调用栈中遇到异步API时，满足条件后，微任务及宏任务的回调函数分别进入相应的事件队列；")]),t._v(" "),e("li",[t._v("等待当前调用栈清空后，依次执行微任务事件队列中的回调函数；")]),t._v(" "),e("li",[t._v("当微任务事件队列及当前调用栈清空后，开始执行宏任务事件队列中的回调函数。如此循环往复，就是"),e("strong",[t._v("Eventloop")]),t._v("。")])]),t._v(" "),e("p",[t._v("这时，回到上文中"),e("code",[t._v("promise")]),t._v("和"),e("code",[t._v("setTimeout")]),t._v("的例子，我们来逐行解析一下：")]),t._v(" "),e("ol",[e("li",[t._v("当前task执行，输出"),e("code",[t._v("script start")])]),t._v(" "),e("li",[t._v("setTimeout的callback被添加进macrotask队列中")]),t._v(" "),e("li",[t._v("实例化"),e("code",[t._v("Promise")]),t._v("，"),e("code",[t._v("Promise.then")]),t._v("的callback被依次添加进microtask队列中")]),t._v(" "),e("li",[t._v("输出"),e("code",[t._v("script end")])]),t._v(" "),e("li",[t._v("当前task执行完毕，call stack为空，依次执行microtask队列中的callback，依次输出1，2")]),t._v(" "),e("li",[t._v("执行下一个task，输出"),e("code",[t._v("setTimeout")])])])])}),[],!1,null,null,null);a.default=n.exports}}]);